/**
 * Copyright (c) 2014, 2017, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";
define(["ojs/ojcore","knockout","promise"],function(a,g){a.Su={};a.Su.Hd={viewPath:"text!views/",viewSuffix:".html",modelPath:"viewModels/",initializeMethod:"initialize",disposeMethod:"dispose",activatedHandler:"handleActivated",attachedHandler:"handleAttached",detachedHandler:"handleDetached",bindingsAppliedHandler:"handleBindingsApplied",deactivatedHandler:"handleDeactivated",transitionCompletedHandler:"handleTransitionCompleted"};o_("ModuleBinding.defaults",a.Su.Hd,a);a.Su.Jza="oj:blank";(function(){function c(b,
c,e,f,h,k,l){var n=c.canAnimate;if(null==n||n.call(c,b)){var r,t;if(n=c.prepareAnimation.call(c,b))r=n.newViewParent,t=n.oldViewParent;var F=r||e;t&&t!==e?d(f,t):F===e&&k(null);F!==e&&g.virtualElements.setDomNodeChildren(F,[]);h(F);var E=Array.prototype.slice.call(F.childNodes),I=!1,G=function(){I||(I=!0,e!==F&&(m(e,E),a.Components&&(p(E,a.Components.Mg),p(E,a.Components.pd))))},H=k.bind(null,t);b.newViewParent=r;b.oldViewParent=t;b.oldViewNodes=f;b.removeOldView=H;b.insertNewView=G;var C=function(){H();
G();l()};return c.animate.call(c,b).then(C,function(){C();a.D.error("ojModule animation promise was rejected")})}}function b(a,b,c){b=b||a;var d=[];c&&a===b&&(c.parentNode.removeChild(c),d.push(c));g.virtualElements.setDomNodeChildren(b,d)}function d(a,b){a.forEach(function(a){b.appendChild(a)})}function e(a,b,c){if(a&&a[b]){var d={element:c[0],valueAccessor:c[1]};2<c.length&&(d.viewModel=c[2],3<c.length&&(d["boolean"===typeof c[3]?"fromCache":"cachedNodes"]=c[3]));return g.ignoreDependencies(a[b],
a,[d])}}function f(b,c,d){if(null!=b&&(c=a.Su.Hd[c],null!=c&&b&&(c=b[c],"function"===typeof c))){var e=void 0;d&&(e={element:d[0],valueAccessor:d[1]},2<d.length&&(e["boolean"===typeof d[2]?"fromCache":"cachedNodes"]=d[2]));return g.ignoreDependencies(c,b,[e])}}function h(a,b,c){var d=[];for(a=g.virtualElements.firstChild(a);null!=a&&a!=c;a=a.nextSibling)a!=b&&d.push(a);return d}function k(a,b){var c=[],d=g.virtualElements.firstChild(a);l(d,b,function(a){c.push(a)});return c}function l(a,b,c){for(;null!=
a;){var d=g.virtualElements.nextSibling(a),e=a.nodeType;a===b||1!==e&&8!==e||c(a);a=d}}function m(a,b){for(var c=b.length-1;0<=c;c--)g.virtualElements.prepend(a,b[c])}function p(a,b){if(b)for(var c=0;c<a.length;c++){var d=a[c];1===d.nodeType&&b(d)}}function t(a,b){if("string"===typeof a)a=g.utils.parseHtmlFragment(a);else if(window.DocumentFragment?a instanceof DocumentFragment:a&&11===a.nodeType)a=g.utils.arrayPushAll([],a.childNodes);else if(Array.isArray(a))a=g.utils.arrayPushAll([],a);else throw b(),
"The View ("+a+") has an unsupported type";return a}function r(b,c){b=b?b:require;return new Promise(function(d,e){b([c],function(a){d(a)},function(b){a.D.error("ojModule failed to load "+c);e(b)})})}function n(a){return a?new Promise(function(b){a.then(b,b)}):a}g.bindingHandlers.ojModule={init:function(q,s,u,v,w){function x(a){if(a!=I)throw P;}function y(a){f(a,"disposeMethod",[q,s])}function z(){C&&(C(),C=null)}var A,D,F={},E,I=-1,G,H,C,B;g.utils.domNodeDisposal.addDisposeCallback(q,function(){y(A);
for(var a=Object.keys(F),b=0;b<a.length;b++)y(F[a[b]].Ao);z()});var P=Error("Promise cancelled because ojModule is fetching new View and ViewModel"),K=q;8===q.nodeType&&(K=q.parentElement,g.virtualElements.setDomNodeChildren(q,[]),H=q.nextSibling);g.computed(function(){I++;C||(C=a.Context.getContext(K).md().ad({description:"ojModule binding on a node with the Id "+q.id+"is loading the module. Binding evaluator: "+s.toString()}));var u=0===I,v=g.utils.unwrapObservable,M=v(s()),O,V,aa,U,Z,ja,T,ka,fa,
ga,ca,S,R;"string"===typeof M?O=M:(O=v(M.name),V=v(M.viewName),aa=v(M.params),U=v(M.viewModelFactory),Z=v(M.createViewFunction),ja=v(M.cacheKey),T=v(M.lifecycleListener),ka=v(M.animation),S=v(M.view),R=v(M.viewModel),fa=v(M.require));null==fa||fa instanceof Function||(ca=fa.viewPath,ga=fa.modelPath,fa=fa.instance);V=null==V?O:V;var L=a.Su.Jza===V,v=e(T,"activated",[q,s]),J,Y;if(L)J=Promise.resolve([]),Y=Promise.resolve(null);else{var da=null==ja?null:F[ja];null!=da&&(delete F[ja],J=Promise.resolve(da.view),
Y=Promise.resolve(da.Ao))}null==J&&null!=S&&(J=Promise.resolve(S));if(null==Y&&(null!=R?Y=Promise.resolve(R):null!=U&&(Y=g.ignoreDependencies(U.createViewModel,U,[aa,s])),null==Y&&null!=O&&(null==ga&&(ga=a.Su.Hd.modelPath),Y=r(fa,ga+O)),null!=Y&&(Y=Y.then(function(a,b){x(a);return b="function"===typeof b?new b(aa):f(b,"initializeMethod",[q,s])||b}.bind(null,I)),null==J&&null!=Z&&(J=Y.then(function(a,b){x(a);if(null==b)throw z(),"createViewFunction option cannot be used when the ViewModel is null";
var c=b[Z];if(null==c)throw z(),"function specified by the createViewFunction option was not found on the ViewModel";return c.call(b)}.bind(null,I)))),null==J))if(null!=V)null==ca&&(ca=a.Su.Hd.viewPath),J=r(fa,ca+V+a.Su.Hd.viewSuffix);else throw z(),Error("View name or view instance must be specified");if(null==J)throw z(),Error("ojModule is missing a View");var W;null!=Y&&(W=Y.then(function(a,b){x(a);return f(b,"activatedHandler",[q,s])}.bind(null,I)));Promise.all([J,Y,v,W,D]).then(function(r,v){if(r==
I){var x=v[0];if(null==x)throw z(),"The module's View was resolved to null";var C=t(x,z),K=v[1],P=!1,X,J=h(q,G,H),Q=k(q,G);null==E||B||(P=!0,X=J,G||(G=document.createElement("div"),G.className="oj-helper-module-cache",g.virtualElements.prepend(q,G)));var M=!1,x=function(c){M||(M=!0,P?d(J,G):Q.forEach(function(a){g.cleanNode(a)}),b(q,c||q,G),u||(e(T,"detached",[q,s,A,X]),f(A,"detachedHandler",[q,s,X]),e(T,"deactivated",[q,s,A]),f(A,"deactivatedHandler",[q,s])),P?(p(X,a.Components?a.Components.jq:null),
F[E]={Ao:A,view:X}):y(A),A=K,E=ja,B=L)},O=function(b){b=b||q;m(b,C);var c=null!=da;c&&p(C,a.Components?a.Components.Bo:null);e(T,"attached",[b,s,K,c]);f(K,"attachedHandler",[b,s,c]);if(!c){var d=w.createChildContext(K,void 0,function(a){a.$module=K;a.$params=aa});l(C[0],G,function(a){g.applyBindings(d,a)});e(T,"bindingsApplied",[b,s,K]);f(K,"bindingsAppliedHandler",[b,s])}},R=function(){e(T,"transitionCompleted",[q,s,K]);f(K,"transitionCompletedHandler",[q,s]);z()};if(null!=ka){var S=c({node:q,valueAccessor:s,
isInitial:u,oldViewModel:A,newViewModel:K},ka,q,J,O,x,R);D=n(S)}else D=void 0;D||(x(null),O(null),R())}}.bind(null,I),function(b,c){c!==P&&null!=c&&(z(),a.D.error(c))}.bind(null,I))},null,{disposeWhenNodeIsRemoved:q});return{controlsDescendantBindings:!0}}};g.virtualElements.allowedBindings.ojModule=!0})()});
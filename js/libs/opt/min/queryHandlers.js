define(["./persistenceManager","./persistenceStoreManager","./persistenceUtils","./impl/logger"],function(a,b,c,d){"use strict";function e(a,b){return b=b||function(a){return g(a)},function(e,g){if("GET"==e.method||"HEAD"==e.method){d.log("Offline Persistence Toolkit queryHandlers: OracleRestQueryHandler processing request");var h,i,k=e.url.split("?"),l={};i="undefined"==typeof URLSearchParams?j(k[1]):new URLSearchParams(k[1]).entries();var m,n,o,p,q;do{m=i.next(),null!=m.value&&(n=m.value[0],o=m.value[1],"q"==n?h=o:"limit"==n?p=o:"offset"==n&&(q=o))}while(!m.done);var r,s,l=b(h);if(null!=g.jsonProcessor&&(r=g.jsonProcessor.shredder,s=g.jsonProcessor.unshredder),null!=r&&null!=s)return f(e,a,l,r,s,q,p).then(function(a){return a?a.clone().text().then(function(b){if(null!=b&&b.length>0)try{var d=JSON.parse(b);return d.links?Promise.resolve(a):(d.links=[{rel:"self",href:e.url}],c.setResponsePayload(a,d).then(function(a){return Promise.resolve(a)}))}catch(a){}}):Promise.resolve()})}return Promise.resolve()}}function f(d,e,f,g,h,i,j){return a.getCache().hasMatch(d,{ignoreSearch:!0}).then(function(k){return b.openStore(e).then(function(a){if(k)return a.find(f);var b=l(d);return b?a.findByKey(b):Promise.resolve([])}).then(function(b){return a.getCache().match(d,{ignoreSearch:!0}).then(function(f){if(f){var k=!1;return b&&(i&&i>0&&(k=i<b.length,b=b.slice(i,b.length)),j&&j>0&&(k=j<=b.length,b=b.slice(0,j))),g(f).then(function(a){var d=a[0].resourceType;return h([{name:e,data:b,resourceType:d}],f).then(function(a){return a.clone().text().then(function(b){if(!(null!=b&&b.length>0))return a;try{var d=JSON.parse(b);return null!=d.items&&(j&&(d.limit=parseInt(j,10)),i&&(d.offset=parseInt(i,10)),d.hasMore=k),c.setResponsePayload(a,d)}catch(a){}})})})}if(b&&Object.keys(b).length>0){var l=m(d);return l?c.requestToJSON(d).then(function(d){return d.url=l,c.requestFromJSON(d).then(function(c){return a.getCache().match(c,{ignoreSearch:!0}).then(function(a){if(a){return h([{name:e,data:[b],resourceType:"single"}],a)}})})}):Promise.resolve()}return Promise.resolve()})})})}function g(a){var b={};if(a){var c,d,e=a.split(";"),f={};for(c=0;c<e.length;c++)if(d=e[c].split("=")[0]){var g=e[c].split("=")[1].replace(/^"|'(.*)'|"$/,"$1");f["value."+d]=g}Object.keys(f).length>0&&(b.selector=f)}return b}function h(a,b){return function(c,e){if("GET"==c.method||"HEAD"==c.method){d.log("Offline Persistence Toolkit queryHandlers: SimpleQueryHandler processing request");var g,h,j=c.url.split("?"),k=i(j,b);if(null!=e.jsonProcessor&&(g=e.jsonProcessor.shredder,h=e.jsonProcessor.unshredder),null!=g&&null!=h)return f(c,a,k,g,h)}return Promise.resolve()}}function i(a,b){var c={};if(a&&a.length>1){var d,e={};d="undefined"==typeof URLSearchParams?j(a[1]):new URLSearchParams(a[1]).entries();var f,g,h;do{f=d.next(),null!=f.value&&(g=f.value[0],h=f.value[1],b&&-1!=b.indexOf(g)||(e["value."+g]=h))}while(!f.done);Object.keys(e).length>0&&(c.selector=e)}return c}function j(a){var b=[];if(null!=a){"?"===a.charAt(0)&&(a=a.slice(1)),a=a||"";var c,d,e,f=a.split("&");b=f.map(function(a){return e=a.indexOf("="),e>-1?(c=a.slice(0,e),d=a.slice(e+1),d=k(d)):(c=a,d=""),c=k(c),[c,d]})}return{next:function(){var a=b.shift();return{done:void 0===a,value:a}}}}function k(a){return decodeURIComponent(a.replace(/\+/g," "))}function l(a){var b=a.url.split("/");return b.length>1?b[b.length-1]:null}function m(a){if(a.url.split("/").length>1){var b=l(a);return a.url.substring(0,a.url.length-b.length-1)}return null}return{getSimpleQueryHandler:h,getOracleRestQueryHandler:e}});
//# sourceMappingURL=queryHandlers.js.map
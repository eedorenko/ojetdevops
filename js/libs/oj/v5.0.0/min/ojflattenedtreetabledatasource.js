/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";define(["ojs/ojcore","jquery","ojs/ojdatasource-common"],function(e,t){e.FlattenedTreeTableDataSource=function(t,a){if(a=a||{},!(t instanceof e.FlattenedTreeDataSource)){var r=e.TableDataSource._LOGGER_MSG._ERR_DATA_INVALID_TYPE_SUMMARY,n=e.TableDataSource._LOGGER_MSG._ERR_DATA_INVALID_TYPE_DETAIL;throw new Error(r+"\n"+n)}this._data=t,this._eventHandlers=[],this._startIndex=0,this._nodeSetList=[],this._hasMore=!0,null==this._data.getOption("fetchSize")&&(this._data.getFetchSize=function(){return-1});var s=this;this._data.insertRows=function(t,a,r){var n,o,i,l,d,c=[],u=[],h=[];for(n=0;n<r.getCount();n++){for(i=r.getData(n),d=r.getMetadata(n).key,l=t+n,s._nodeSetList.splice(l,0,{}),s._nodeSetList[l].nodeSet=r,s._nodeSetList[l].startIndex=t,o=l+1;o<s._nodeSetList.length;o++)s._nodeSetList[o].startIndex=s._nodeSetList[o].startIndex+1;c.push(s._wrapWritableValue(i)),u.push(d),h.push(l),s._rows.data.splice(l,0,i),s._rows.keys.splice(l,0,d),s._rows.indexes.splice(l,0,l)}s._realignRowIndices(),s._hasMore=!0,e.TableDataSource.superclass.handleEvent.call(s,e.TableDataSource.EventType.ADD,{data:c,keys:u,indexes:h})},this._data.removeRows=function(t){var a,r,n,o=[],i=[],l=[];for(a=t.length-1;a>=0;a--){for(n=t[a].index,o.push(""),i.push(t[a].key),l.push(n),s._nodeSetList.splice(n,1),r=n;r<s._nodeSetList.length;r++)s._nodeSetList[r].startIndex=s._nodeSetList[r].startIndex-1;s._rows.data.splice(n,1),s._rows.keys.splice(n,1),s._rows.indexes.splice(n,1)}l=l.sort(function(e,t){return e-t}),s._realignRowIndices(),s._hasMore=!0,e.TableDataSource.superclass.handleEvent.call(s,e.TableDataSource.EventType.REMOVE,{data:o,keys:i,indexes:l})},this.Init(),(null==a||"enabled"!=a.startFetch&&null!=a.startFetch)&&null!=a||(this._startFetchEnabled=!0)},e.Object.createSubclass(e.FlattenedTreeTableDataSource,e.TableDataSource,"oj.FlattenedTreeTableDataSource"),e.FlattenedTreeTableDataSource.prototype.Init=function(){e.FlattenedTreeTableDataSource.superclass.Init.call(this)},e.FlattenedTreeTableDataSource.prototype.getCapability=function(e){return"full"},e.FlattenedTreeTableDataSource.prototype.getWrappedDataSource=function(){return this._data},e.FlattenedTreeTableDataSource.prototype.fetch=function(e){return"init"!=(e=e||{}).fetchType||this._startFetchEnabled?this._fetchInternal(e):Promise.resolve()},e.FlattenedTreeTableDataSource.prototype.at=function(e,t){var a;return a=e<0||e>=this._rows.data.length?null:{data:this._rows.data[e],index:e,key:this._rows.keys[e]},new Promise(function(e,t){e(a)})},e.FlattenedTreeTableDataSource.prototype.collapse=function(e){this._data.collapse(e)},e.FlattenedTreeTableDataSource.prototype.expand=function(e){this._data.expand(e)},e.FlattenedTreeTableDataSource.prototype.get=function(e,t){var a=this._data.getIndex(Object(e)),r=this._rows.data[a],n={data:this._wrapWritableValue(r),key:e,index:a};return Promise.resolve(n)},e.FlattenedTreeTableDataSource.prototype.on=function(t,a){"expand"==t||"collapse"==t?this._data.on(t,a):e.FlattenedTreeTableDataSource.superclass.on.call(this,t,a)},e.FlattenedTreeTableDataSource.prototype.off=function(t,a){"expand"==t||"collapse"==t?this._data.off(t,a):e.FlattenedTreeTableDataSource.superclass.off.call(this,t,a)},e.FlattenedTreeTableDataSource.prototype.sort=function(t){null==t?t=this.sortCriteria:this.sortCriteria=t;var a=this;return t.axis="column",new Promise(function(r,n){a._data.getWrappedDataSource().sort(t,{success:function(n){setTimeout(function(){a._data.refresh(),a._rows=null;var n={header:t.key,direction:t.direction};e.TableDataSource.superclass.handleEvent.call(a,e.TableDataSource.EventType.RESET,null),r(n)},0)}.bind(this),error:function(e){n(e)}.bind(this)})})},e.FlattenedTreeTableDataSource.prototype.totalSize=function(){return this._hasMore?-1:this._rows.data.length},e.FlattenedTreeTableDataSource.prototype.totalSizeConfidence=function(){return this._hasMore?"unknown":"actual"},e.FlattenedTreeTableDataSource.prototype._getMetadata=function(e){var t=this._nodeSetList[e].nodeSet.getStart();return this._nodeSetList[e].nodeSet.getMetadata(t+e-this._nodeSetList[e].startIndex)},e.FlattenedTreeTableDataSource.prototype._fetchInternal=function(t){t=t||{},this._startFetch(t),this._startIndex=null==t.startIndex?this._startIndex:t.startIndex;var a=Number.MAX_VALUE;this._pageSize=null==t.pageSize?this._pageSize:t.pageSize,null!=this._pageSize&&(a=this._pageSize);var r=this._startIndex;if(null!=this._rows)if(null!=this._pageSize){var n=this._rows.data.length-1;if(this._startIndex+this._pageSize-1<=n){n=e.FlattenedTreeTableDataSource._getEndIndex(this._rows,this._startIndex,this._pageSize);var s,o,i=[],l=[];for(s=this._startIndex;s<=n;s++)o=this._rows.keys[s],i[s-this._startIndex]=this._wrapWritableValue(this._rows.data[s]),l[s-this._startIndex]=o;var d={data:i,keys:l,startIndex:this._startIndex};return this._endFetch(t,d,null),Promise.resolve(d)}this._startIndex<=n&&(r=n+1)}else this._data.refresh(),this._rows=null;else r=0;var c={start:r,count:a},u=this;return new Promise(function(a,r){u._data.fetchRows(c,{success:function(r){u._handleFetchRowsSuccess(r),t.refresh=!0;var n,s,o=e.FlattenedTreeTableDataSource._getEndIndex(u._rows,u._startIndex,u._pageSize),i=[],l=[];for(n=u._startIndex;n<=o;n++)s=u._rows.keys[n],i[n-u._startIndex]=u._wrapWritableValue(u._rows.data[n]),l[n-u._startIndex]=s;i.length>0?null!=u._pageSize&&i.length<u._pageSize?u._hasMore=!1:u._hasMore=!0:u._hasMore=!1;var d={data:i,keys:l,startIndex:u._startIndex};u._endFetch(t,d,null),a(d)}.bind(this),error:function(e){u._endFetch(t,null,e),r(e)}.bind(this)})})},e.FlattenedTreeTableDataSource.prototype._handleFetchRowsSuccess=function(t){var a,r,n=t.getStart();for(a=0;a<t.getCount();a++)r=n+a,this._nodeSetList[r]={},this._nodeSetList[r].nodeSet=t,this._nodeSetList[r].startIndex=n;this._rows||(this._rows={},this._rows.data=[],this._rows.keys=[],this._rows.indexes=[]),e.FlattenedTreeTableDataSource._getRowArray(t,this,this._rows,n)},e.FlattenedTreeTableDataSource.prototype._startFetch=function(t){t.silent||e.TableDataSource.superclass.handleEvent.call(this,e.TableDataSource.EventType.REQUEST,{startIndex:t.startIndex})},e.FlattenedTreeTableDataSource.prototype._endFetch=function(t,a,r){null!=r?e.TableDataSource.superclass.handleEvent.call(this,e.TableDataSource.EventType.ERROR,r):t.silent||e.TableDataSource.superclass.handleEvent.call(this,e.TableDataSource.EventType.SYNC,a)},e.FlattenedTreeTableDataSource._getEndIndex=function(e,t,a){var r=e.data.length-1;return a>0&&(r=(r=t+a-1)>e.data.length-1?e.data.length-1:r),r},e.FlattenedTreeTableDataSource._getRowArray=function(e,t,a,r){var n;for(n=0;n<e.getCount();n++){var s=e.getData(e.getStart()+n);a.data[r+n]=s,a.keys[r+n]=e.getMetadata(e.getStart()+n).key,a.indexes[r+n]=r+n}},e.FlattenedTreeTableDataSource.prototype._realignRowIndices=function(){for(var e=0;e<this._rows.data.length;e++)this._rows.indexes[e]=e},e.FlattenedTreeTableDataSource.prototype._wrapWritableValue=function(a){var r,n=t.extend(!0,{},a),s=Object.keys(a);for(r=0;r<s.length;r++)e.FlattenedTreeTableDataSource._defineProperty(n,a,s[r]);return n},e.FlattenedTreeTableDataSource._defineProperty=function(e,t,a){Object.defineProperty(e,a,{get:function(){return t[a]},set:function(e){t[a]=e},enumerable:!0})}});
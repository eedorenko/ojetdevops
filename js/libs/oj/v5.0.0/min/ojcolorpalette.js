/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";define(["ojs/ojcore","jquery","ojs/ojcomponentcore","ojs/ojarraytabledatasource","ojs/ojcolor","ojs/ojlistview","ojs/ojeditablevalue"],function(t,e){t.__registerWidget("oj.ojColorPalette",e.oj.editableValue,{widgetEventPrefix:"oj",defaultElement:"<input>",options:{labelledBy:null,palette:null,swatchSize:"lg",labelDisplay:"off",layout:"grid",value:null},getNodeBySubId:function(t){if(null==t)return this.element?this.element[0]:null;var e,i=t.subId,a=t.index,o=this._super(t);if(!o)switch(i){case"oj-palette-entry":(e=this._$LV.find(".oj-listview-item")).length&&a<e.length&&(o=e[a])}return o},getSubIdByNode:function(t){var i,a,o=e(t),s=null,l=-1,n=null;return o.is("li")&&o.hasClass("oj-listview-item-element")&&(s="oj-palette-entry",i=o.attr("id"),a=this._$LV.find(".oj-listview-item"),e.each(a,function(t,a){if(e(a).attr("id")===i)return l=t,!1})),s&&(n={subId:s},l>=0&&(n.index=l)),null==n&&(n=this._super(t)),n},add:function(e){var i=null;e instanceof t.Color?i={color:e}:"object"==typeof e&&e.color instanceof t.Color&&(i=e),i&&(this._setPaletteBusyContext("The swatch add is being animated in the palette (id="+this.element.attr("id")+")."),i.id=this._getNewSwatchId(),this._opStack||(this._opStack=[]),this._opStack.push({op:"a",obj:i}),this._palDataSource.add(i),this._waitForLV())},remove:function(e){var i,a,o=null;"number"==(i=typeof e)?e>=0&&e<this._palette.length?o=this._palette[e].id:t.Logger.error("JET Color Palette (id='"+this.element.attr("id")+"'): Invalid index for remove ("+e+")"):"object"===i&&(a=e instanceof t.Color?e:e.color,o=this._findSwatchIdOfColorInPalette(a)),o&&(e={id:o},this._setPaletteBusyContext("The removed swatch is being animated in the palette (id="+this.element.attr("id")+")."),this._opStack||(this._opStack=[]),this._opStack.push({op:"r",obj:e}),this._palDataSource.remove(e),this._waitForLV())},whenReady:function(){var t=this;return new Promise(function(e,i){t._$LV.ojListView("whenReady").then(function(t){e(!0)})})},_destroy:function(){this._resolvePaletteBusyContext(),this._$LV&&(this._opStack=[],this._$LV.ojListView("destroy")),this._palDataSource=null,this._$paletteContainer.remove(),this._$boundElem.removeClass("oj-colorpalette"),this._clear(),this._super()},_ComponentCreate:function(){this._super(),this._initPalette()},_AfterCreate:function(){var e;if(this._super(),this._updateLabelledBy(null,this.options.labelledBy,this._$LV),this._IsCustomElement()||(e=this._GetLabelElement()),e){var i=e.attr("id");i?this._$LV.attr("aria-labelledby",i):t.Logger.warn("JET Color Palette: The label for this component needs an id in order to be accessible")}else{var a=this.element.attr("aria-label");a&&this._$LV.attr("aria-label",a)}},_setOption:function(t,e,i){var a=this.options.labelledBy,o=!1;switch(t){case"value":o=this._setOptValue(e);break;case"palette":this._setOptPalette(e);break;case"swatchSize":this._setOptSwatchSize(e);break;case"layout":this._setOptLayout(e);break;case"labelDisplay":this._setOptLabelDisplay(e);break;case"disabled":this._setOptDisabled(e,!0);break;case"labelledBy":this._updateLabelledBy(a,e,this._$LV)}o||this._super(t,e,i)},_updateLabelledBy:t.EditableValueUtils._updateLabelledBy,_onLVOptionChange:function(t,e){"selection"===e.option&&this._selected(t,e)},_waitForLV:function(){if(!this._LVResolve){var e=this;this._LVResolve=t.Context.getContext(this._$LV[0]).getBusyContext(),this._LVResolve.whenReady().then(function(){var t,i,a,o,s,l;if(e._LVResolve=null,e._resolvePaletteBusyContext(),e._opStack){for(a=!1,s=0;s<e._opStack.length;s++)i=(t=e._opStack[s]).obj,"a"!==t.op&&"r"!==t.op||(a=!0,o||(o=e._palette.slice(0)),"a"===t.op?o.push(i):"r"===t.op&&(l=e._findIndexOfSwatchById(o,i.id),o.splice(l,1),t.index=l));if(a)for(e._fireOptionChangeEvent("palette",o,null);e._opStack.length;)i=(t=e._opStack.shift()).obj,"a"===t.op?e._palette.push(i):"r"===t.op&&e._palette.splice(t.index,1)}},function(){t.Logger.error("JET Color Palette (id='"+e.element.attr("id")+"'): ListView timed out."),e._opStack=[]})}},_compareColorValues:function(e,i){var a=e instanceof t.Color,o=i instanceof t.Color,s=!1;return a&&o&&(s=e.isEqual(i)),s},_fireOptionChangeEvent:function(t,e,i){"palette"===t&&this.option(t,e,{_context:{originalEvent:i,internalSet:!0},changed:!0})},_findColorInPalette:function(t){var e,i,a=-1,o=this._palette,s=o.length;for(e=0;e<s;e++)if(i=o[e],t.isEqual(i.color)){a=e;break}return a},_findSwatchIdOfColorInPalette:function(t){var e,i,a=null,o=this._palette,s=o.length;for(e=0;e<s;e++)if(i=o[e],t.isEqual(i.color)){a=i.id;break}return a},_findIndexOfSwatchById:function(t,e){var i,a=-1,o=t.length;for(i=0;i<o;i++)if(t[i].id===e){a=i;break}return a},_setPaletteBusyContext:function(e){if(!this._resolve){var i=t.Context.getContext(this.element[0]).getBusyContext();this._resolve=i.addBusyState({description:e})}},_resolvePaletteBusyContext:function(){this._resolve&&(this._resolve(),this._resolve=null)},_renderer:function(e){var i,a,o,s,l,n;(i=e.data.color)instanceof t.Color||(i=t.Color.BLACK,t.Logger.warn("JET Color Palette (id='"+this.element.attr("id")+"'): Substituting oj.Color.BLACK for an object that is not an instance of oj.Color")),a=o=e.data.label,s="auto"===this._labelDisplay&&"list"===this._layout&&"sm"===this._swatchSize||"auto"===this._labelDisplay&&"grid"===this._layout&&"lg"===this._swatchSize,null!=i&&(n=a||this._convHex.format(i),s?(a=n||this._convHex.format(i),a=o?a:a.toUpperCase()):a=null,l=!!(this._isTransparent(i)||a&&"none"===a.toLowerCase()));var r,h="";return this._initSelection===e.data.id&&(h="oj-selected",this._initSelection=-1,this._selectedParent=e.parentElement),r="list"===this._layout?"oj-colorpalette-swatchsize-"+this._swatchSize+(l?" oj-colorpalette-swatch-none":""):this._swatchClass+(l?" oj-colorpalette-swatch-none":""),l?this._renderNone(s,a,n,r,h):this._renderStandard(i,s,a,n,r,h)},_renderStandard:function(t,i,a,o,s,l){var n;return n="<div class='oj-colorpalette-swatch-entry "+s+(i?" oj-colorpalette-swatch-showlabel":"")+"'><div class='oj-colorpalette-swatch-container'><div class='oj-colorpalette-swatch "+l+"' style='background-color:"+t.toString()+"'"+(a?"":" title='"+o+"'")+"></div></div>",a&&(n+="<span class='oj-colorpalette-swatch-text'>"+a+"</span>"),e(n+="</div>")[0]},_renderNone:function(t,i,a,o,s){var l;return l="<div class='oj-colorpalette-swatch-entry "+o+(t?" oj-colorpalette-swatch-showlabel":"")+"'><div class='oj-colorpalette-swatch-container'><div class='oj-colorpalette-swatch "+s+"'"+(i?"":" title='"+a+"'")+"><div class='oj-colorpalette-swatch-none-icon'></div></div></div>",i&&(l+="<span class='oj-colorpalette-swatch-text'>"+i+"</span>"),e(l+="</div>")[0]},_selected:function(t,i){var a,o,s=null;if((a=e(i.items[0]).find(".oj-colorpalette-swatch")).addClass("oj-selected"),o=this._selectedSwatch,this._selectedSwatch=a,o||this._selectedParent&&(o=e(this._selectedParent).find(".oj-colorpalette-swatch"),this._selectedParent=null),o&&o.removeClass("oj-selected"),1===i.value.length){for(var l=0;l<this._palette.length;l++)if(this._palette[l].id===i.value[0]){s=this._palette[l].color;break}this._SetValue(s,t),this._value=s}},_setOptDisabled:function(t,i){var a,o;(!i||i&&t!==this._disabled)&&(this._$LV&&this._$LV.ojListView("option","disabled",t),a=e(".oj-colorpalette-container .oj-colorpalette-swatch"),o=this,t?(this._disabledBG=[],e.each(a,function(t,e){o._disabledBG.push(e.style.backgroundColor),e.style.backgroundColor="#eee"})):(this._disabledBG&&this._disabledBG.length&&e.each(a,function(t,e){e.style.backgroundColor=o._disabledBG[t]}),this._disabledBG=null),this._disabled=t)},_setOptValue:function(e){var i=-1,a=[];if(this._palette.length>0&&e instanceof t.Color&&!this._compareColorValues(this._value,e)){if((i=this._findColorInPalette(e))>=0&&null!=this._palette[i].id){var o=this._palette[i].id;a.push(o)}this._$LV.ojListView("option","selection",a),this._value=e}return a.length>0},_setOptPalette:function(t){e.isArray(t)&&(this._isPaletteEqual(t,this._palette)||(this._setPaletteBusyContext("The palette (id="+this.element.attr("id")+") option change in progress."),this._opStack=[],this._palette=t.slice(0),this._initSelection=this._findColorInPalette(this._value),this._setData(t,this._initSelection,!0),this._waitForLV()))},_setOptSwatchSize:function(t){"string"==typeof t&&t!==this._swatchSize&&(this._swatchSize=t,this._swatchClass="oj-colorpalette-swatchsize-"+("lg"===t?"lg":"sm"===t?"sm":"xs"),this._$LV.ojListView("refresh"))},_setOptLabelDisplay:function(t){"string"==typeof t&&t!==this._labelDisplay&&("auto"!==t&&"off"!==t||(this._labelDisplay=t,this._$LV.ojListView("refresh")))},_setOptLayout:function(t){"string"==typeof t&&t!==this._layout&&(this._layout=t,this._setDisplayFormat(),this._$LV.ojListView("refresh"))},_setDisplayFormat:function(){var t="grid"===this._layout,e=t?"oj-colorpalette-grid":"oj-colorpalette-list";this._$LV.removeClass("oj-colorpalette-grid oj-colorpalette-list oj-listview-card-layout"),this._$LV.addClass(e),t&&this._$LV.addClass("oj-listview-card-layout")},_setData:function(e,i,a){this._addIdsToPalette(e),this._palDataSource=new t.ArrayTableDataSource(e,{idAttribute:"id"}),i>=0&&(this._palette[i].id&&(i=this._palette[i].id),0===this._palInitSelected.length?this._palInitSelected.push(i):this._palInitSelected[0]=i),a&&this._$LV.ojListView("option","data",this._palDataSource)},_initPalette:function(){this._setPaletteBusyContext("Palette (id="+this.element.attr("id")+") is initializing."),this._initData(),this._setup()},_setup:function(){this._$boundElem.append(this._markup),this._$boundElem.addClass("oj-colorpalette"),this._$paletteContainer=this._$boundElem.find(".oj-colorpalette-container"),this._$LV=this._$paletteContainer.find(":first"),this._$LV.attr("data-oj-context",""),this._value&&this._value instanceof t.Color&&(this._initSelection=this._findColorInPalette(this._value)),this._swatchId=0,this._setData(this._palette,this._initSelection,!1),this._$LV.ojListView({data:this._palDataSource,item:{renderer:this._renderer.bind(this)},optionChange:this._onLVOptionChange.bind(this),selectionMode:"single",selection:this._palInitSelected,rootAttributes:{style:"height:100%;width:100%"}}).attr("data-oj-internal","");var e=this;t.Context.getContext(this._$LV[0]).getBusyContext().whenReady().then(function(){if(e._$LV.ojListView("option","translations.msgNoData",""),e._setOptDisabled(e._disabled),e._$LV[0].scrollWidth>e._$LV[0].clientWidth){var t=e._getScrollbarWidth(),i="rtl"===e._GetReadingDirection();e._$LV.css(i?"padding-left":"padding-right",t+1)}e._resolvePaletteBusyContext()})},_initData:function(){var e;this._applyOptions(),this._converterFactory=t.Validation.converterFactory(t.ConverterFactory.CONVERTER_TYPE_COLOR),this._convHex=this._converterFactory.createConverter({format:"hex"}),this._labelNone=this.getTranslatedString("labelNone"),e="grid"===this._layout?"oj-colorpalette-grid oj-listview-card-layout":"oj-colorpalette-list",this._markup=["<div class='oj-colorpalette-container'>","<ul class='"+e+"'/>","</div>"].join("")},_applyOptions:function(){var i,a=this.options;this._doc=this.element[0].ownerDocument,this._body=this._doc.body,this._$boundElem=e(this.element),this._disabled=!1,this._palInitSelected=[],this._palDataSource=null,"string"==typeof(i=a.swatchSize)&&"lg"!==(i=i.toLowerCase())&&"sm"!==i&&"xs"!==i&&(i="lg"),this._swatchSize=i,this._swatchClass="oj-colorpalette-swatchsize-"+i,"string"==typeof(i=a.labelDisplay)&&"auto"!==(i=i.toLowerCase())&&"off"!==i&&(i="auto"),this._labelDisplay=i,"string"==typeof(i=a.layout)&&("grid"!==(i=i.toLowerCase())&&"list"!==i&&(i="grid"),"grid"!==i&&"xs"===this._swatchSize&&(i="grid")),this._layout=i,(i=a.value)instanceof t.Color||(i=null),this._value=i||t.Color.BLACK,i=a.palette,e.isArray(i)||(i=[]),this._palette=i.slice(0),"boolean"==typeof(i=a.disabled)&&(this._disabled=i)},_isTransparent:function(t){var e=t.getRed(),i=t.getGreen(),a=t.getBlue(),o=t.getAlpha();return 0===e&&0===i&&0===a&&0===o},_isPaletteEqual:function(t,e){var i,a,o,s,l=t.length;if(s=!1,l===e.length){for(o=0;o<l&&(i=t[o],a=e[o],!this._compareColorValues(i.color,a.color)||i.label===a.label);o++);s=o>=l}return s},_addIdsToPalette:function(t){var e,i=t.length;for(e=0;e<i;e++)t[e].id=this._getNewSwatchId()},_getNewSwatchId:function(){var t=this._swatchId.toString();return this._swatchId++,t},_clear:function(){this._converterFactory=this._convHex=this._markup=this._$LV=null},_getScrollbarWidth:function(){var t=e("<div style='overflow: scroll; width: 100px; height: 100px; position: absolute; visibility: hidden;'><div style='width: 100%; height: 100%;'></div></div>");this.element.append(t);var i=t[0].offsetWidth,a=t.children()[0].offsetWidth;return t.remove(),i-a},_GetMessagingLauncherElement:function(){return this.element},_GetContentElement:function(){return this._$LV},_GetElementValue:function(){return this._value},_SetDisplayValue:function(e){e?this._value="string"==typeof e?new t.Color(e):e:(this._value=t.Color.BLACK,t.Logger.warn("JET Color Palette (id='"+this.element.attr("id")+"'): Substituting oj.Color.BLACK since display value is not defined."))},_GetDisplayValue:function(){return this._value.toString()},_GetDefaultStyleClass:function(){return"oj-colorpalette"}}),t.CustomElementBridge.registerMetadata("oj-color-palette","editableValue",{properties:{labelDisplay:{type:"string",enumValues:["auto","off"]},labelledBy:{type:"string"},layout:{type:"string",enumValues:["grid","list"]},palette:{type:"Array"},swatchSize:{type:"string",enumValues:["lg","sm","xs"]},translations:{type:"Object",properties:{labelNone:{type:"string",value:"None"}}},value:{writeback:!0}},extension:{_WIDGET_NAME:"ojColorPalette"}}),t.CustomElementBridge.register("oj-color-palette",{metadata:t.CustomElementBridge.getMetadata("oj-color-palette")})});
/**
 * @license
 * Copyright (c) 2014, 2018, Oracle and/or its affiliates.
 * The Universal Permissive License (UPL), Version 1.0
 */
"use strict";define(["ojs/ojcore","jquery","hammerjs","promise","ojs/ojjquery-hammer","ojs/ojcomponentcore"],function(e,t,n){e.IndexerModel=function(){},e.IndexerModel.SECTION_OTHERS={id:"__others__",label:e.Translations.getTranslatedString("oj-ojIndexer.indexerOthers")},e.ListViewIndexerModel=function(e){this.listview=e,this.Init()},e.Object.createSubclass(e.ListViewIndexerModel,e.EventSource,"oj.ListViewIndexerModel"),e.ListViewIndexerModel.prototype.getIndexableSections=function(){return this.listview.ojContext.getTranslatedString("indexerCharacters").split("|")},e.ListViewIndexerModel.prototype.getMissingSections=function(){return null==this.missingSections&&(this.missingSections=this._getMissingSections()),this.missingSections},e.ListViewIndexerModel.prototype._getMissingSections=function(){var e,n,i,r,s,a,o=[];for(e=this.listview._getGroupItemsCache(),n=this.getIndexableSections(),i=0;i<n.length;i++)r=n[i],s=!1,e.each(function(e){if((a=t(this).text()).length>0&&a.charAt(0)==r)return s=!0,!1}),s||o.push(r);return o},e.ListViewIndexerModel.prototype.setSection=function(t){return t==e.IndexerModel.SECTION_OTHERS?this._setOtherSection():this._setSection(t)},e.ListViewIndexerModel.prototype._setOtherSection=function(){var n,i,r,s,a,o=this;return n=this.getIndexableSections(),new Promise(function(l,u){i=null,o.listview._getGroupItemsCache().each(function(e){for(r=t(this).text(),s=0;s<n.length;s++)if(a=n[s],0==r.indexOf(a))return!0;return i=this,!1}),i?(o.listview._scrollToGroupHeader(i),l(e.IndexerModel.SECTION_OTHERS)):l(null)})},e.ListViewIndexerModel.prototype._setSection=function(e){var t,n,i,r=this,s=null;return t=this.getIndexableSections(),n=t.indexOf(e),new Promise(function(a,o){if(-1==n)a(null);else{for(;n<t.length;){if(e=t[n],null!=(i=r._findGroupHeader(e))){r.listview._scrollToGroupHeader(i),s=e;break}n++}a(s)}})},e.ListViewIndexerModel.prototype._findGroupHeader=function(e){var n;return this.listview._getGroupItemsCache().each(function(i){if(0==t(this).text().indexOf(e))return n=this,!1}),n},e.__registerWidget("oj.ojIndexer",t.oj.baseComponent,{defaultElement:"<ul>",version:"1.2",widgetEventPrefix:"oj",options:{data:null},_ComponentCreate:function(){this._super(),this._setup()},_AfterCreate:function(){this._super(),this._createIndexerContent(),this._setAriaProperties(),this._createInstructionText()},_destroy:function(){this._super(),this._unsetAriaProperties(),this.element.removeClass("oj-component-initnode"),e.DomUtils.unwrap(this.element,this._getIndexerContainer())},_setOption:function(e,t){this._superApply(arguments),"data"==e&&this.refresh()},_SetupResources:function(){this._super();var e=this._getIndexerContainer()[0];this._registerResizeListener(e),this._registerTouchHandler(e)},_ReleaseResources:function(){this._super();var e=this._getIndexerContainer()[0];this._unregisterResizeListener(e),this._unregisterTouchHandler(e),this._resolveBusyState()},_resolveBusyState:function(){this.busyStateResolve&&(this.busyStateResolve(null),this.busyStateResolve=null)},widget:function(){return this._getIndexerContainer()},refresh:function(){this._super(),this.element.empty(),this._createIndexerContent(),this._setAriaProperties(),this.m_current=null},getNodeBySubId:function(e){var n,i,r,s,a,o;if(null==e)return this.element?this.element[0]:null;if("oj-indexer-section"===e.subId)for(n=e.section,i=this.element.children("li"),r=0;r<i.length;r++){if(a=i.get(r),t(a).data("data-range")==n)return a;if(null!=(o=t(a).data("data-includes")))for(s=0;s<o.length;s++)if(o[s]==n)return a}return null},getSubIdByNode:function(e){var n;return null!=e&&null!=(n=t(e).data("data-range"))?{subId:"oj-indexer-section",section:n}:null},_setAriaProperties:function(){this.element.attr("role","slider").attr("aria-orientation","vertical").attr("aria-describedby",this.element.prop("id")+":desc").attr("aria-valuemin",0).attr("aria-valuemax",Math.max(0,this.element.children().length-1))},_unsetAriaProperties:function(){this.element.removeAttr("role").removeAttr("aria-orientation").removeAttr("aria-describedby").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuetext")},_createInstructionText:function(){var n,i;n=e.DomUtils.isTouchSupported()?"ariaTouchInstructionText":"ariaKeyboardInstructionText",(i=t(document.createElement("div"))).prop("id",this.element.prop("id")+":desc"),i.addClass("oj-helper-hidden-accessible").text(this.getTranslatedString(n)),this._getIndexerContainer().append(i)},_getIndexerContainer:function(){return null==this.m_container&&(this.m_container=this._createIndexerContainer()),this.m_container},_createIndexerContainer:function(){var e;return this.OuterWrapper?e=t(this.OuterWrapper):(e=t(document.createElement("div")),this.element.parent()[0].replaceChild(e[0],this.element[0])),e.addClass("oj-indexer oj-component"),e.prepend(this.element),e},_createIndexerContent:function(){var e,t,n,i,r,s,a,o,l,u,d,h,c,_,g;if(null!=(e=this._getIndexerModel())){for(t=this.element,n=e.getIndexableSections(),e.getMissingSections&&(i=e.getMissingSections()),r=this.getTranslatedString("indexerOthers"),s=this.widget().outerHeight(),a=this._createItem(n[0],i),t.append(a),o=a.outerHeight(),l=Math.floor(s/o),this._getIndexerContainer().removeClass("oj-indexer-abbr"),(u=Math.floor((n.length+1)/l)+1)>1&&this._getIndexerContainer().addClass("oj-indexer-abbr"),d=1+u;d<n.length;d=d+u+1)u>1?(c=this._createSeparator(n,d-u,d-1),t.append(c)):d--,h=n[d],c=this._createItem(h,i),t.append(c);_=this._createItem(n[n.length-1],i),t.append(_),(g=this._createItem(r)).attr("data-others","true"),t.append(g)}},_createItem:function(e,n){var i,r;return i=e.label?e.label:e,(r=t(document.createElement("li"))).data("data-range",e).text(i),null!=n&&n.indexOf(e)>-1&&r.addClass("oj-disabled"),r},_createSeparator:function(e,n,i){var r,s,a=[];for((r=t(document.createElement("li"))).addClass("oj-indexer-ellipsis").data("data-range",e[n+Math.round((i-n)/2)]),s=n;s<=i;s++)a.push(e[s]);return r.data("data-includes",a),r},_setup:function(){var e=this;this.element.uniqueId().addClass("oj-component-initnode").attr("tabIndex",0),this._on(this.element,{click:function(t){e._handleClick(t)},keydown:function(t){e._handleKeyDown(t)},focus:function(t){e._handleFocus(t)},blur:function(t){e._handleBlur(t)}}),this._focusable({applyHighlight:!0,setupHandlers:function(t,n){e._focusInHandler=t,e._focusOutHandler=n}})},_handleClick:function(e){var n;0===e.button&&(n=t(e.target),this._setCurrent(n))},_handleFocus:function(e){this._getIndexerContainer().addClass("oj-focus-ancestor"),null==this.m_current?this._setFocus(this.element.children("li").first()):this._setFocus(this.m_current)},_handleBlur:function(e){this._getIndexerContainer().removeClass("oj-focus-ancestor")},_handleKeyDown:function(e){var t,n=!1;switch(e.keyCode){case 38:t=this.m_current.prev();break;case 40:t=this.m_current.next();break;case 13:this._setCurrent(this.m_current),n=!0}null!=t&&t.length>0&&(n=!0,this._setFocus(t)),n&&e.preventDefault()},_setFocus:function(e){null!=this.m_current&&this._focusOutHandler(this.m_current),this._focusInHandler(e),this._updateAriaProperties(e),this.m_current=e},_getIndexerModel:function(){var e=this.option("data");if(null!=e&&(null==e.setSection||null==e.getIndexableSections))throw"Invalid IndexerModel";return e},_setCurrent:function(t){var n=t.data("data-range");t.attr("data-others")&&(n=e.IndexerModel.SECTION_OTHERS),this._setCurrentSection(n)},_setCurrentSection:function(t){var n,i,r=this;n=e.Context.getContext(this.element[0]).getBusyContext(),this.busyStateResolve=n.addBusyState({description:"setCurrentSection"}),this._getIndexerModel().setSection(t).then(function(e){null!=e&&null!=(i=r._findItem(e))&&r._setFocus(i),r._resolveBusyState()},function(e){r._resolveBusyState()})},_updateAriaProperties:function(t){var n,i,r,s,a="";null!=(n=t.data("data-includes"))?n.length>0&&(r=n[0].label?n[0].label:n[0],s=n[n.length-1].label?n[n.length-1].label:n[n.length-1],a=this.getTranslatedString("ariaInBetweenText",{first:r,second:s})):a=(i=t.data("data-range"))===e.IndexerModel.SECTION_OTHERS?this.getTranslatedString("ariaOthersLabel"):i,t.hasClass("oj-disabled")&&(a=a+". "+this.getTranslatedString("ariaDisabledLabel")),this.element.attr("aria-valuetext",a),this.element.attr("aria-valuenow",t.index())},_findItem:function(e){var n,i,r,s,a;for(n=this.element.children(),i=0;i<n.length;i++)if(r=n.get(i),s=t(r).data("data-range"),a=t(r).data("data-includes"),null!=s&&s==e||null!=a&&a.indexOf(e)>-1)return t(r);return null},_unregisterResizeListener:function(t){t&&this._resizeHandler&&e.DomUtils.removeResizeListener(t,this._resizeHandler)},_registerResizeListener:function(t){t&&(null==this._resizeHandler&&(this._resizeHandler=this._handleResize.bind(this)),e.DomUtils.addResizeListener(t,this._resizeHandler))},_unregisterTouchHandler:function(e){this.hammer&&(this.hammer.off("panstart panmove panend"),t(e).ojHammer("destroy")),this.hammer=null},_registerTouchHandler:function(e){var i,r,s,a,o,l,u,d,h,c,_,g,m=this;i={recognizers:[[n.Pan,{direction:n.DIRECTION_VERTICAL}]]},this.hammer=t(e).ojHammer(i).on("panstart",function(e){r=e.gesture.target,s=m.element[0].getBoundingClientRect().left+5,a=r.getBoundingClientRect().top,m._setCurrent(t(r)),o=r,l=t(r).data("data-range"),u=a}).on("panmove",function(e){d=u,u=a+e.gesture.deltaY,null!=(r=document.elementFromPoint(s,u))&&(h=u-d,o==r?null!=(c=t(r).data("data-includes"))&&(_=c.indexOf(l),g=null,h>0&&_<c.length-1?g=c[_+1]:h<0&&_>0&&(g=c[_-1]),null!=g&&(l=g,m._setCurrentSection(g))):t(r).data("data-range")&&(c=t(r).data("data-includes"),g=null,null!=c&&(h>0&&r==o.nextElementSibling?g=c[0]:h<0&&r==o.previousElementSibling&&(g=c[c.length-1])),null==g&&(g=t(r).data("data-range")),o=r,l=g,m._setCurrentSection(l)))}).on("panend",function(e){o=null,l=null,u=null,g=null})},_handleResize:function(e,t){e>0&&t>0&&this.refresh()}}),e.CustomElementBridge.registerMetadata("oj-indexer","baseComponent",{properties:{data:{},translations:{type:"Object",properties:{ariaDisabledLabel:{type:"string"},ariaInBetweenText:{type:"string"},ariaKeyboardInstructionText:{type:"string"},ariaOthersLabel:{type:"string"},ariaTouchInstructionText:{type:"string"},indexerCharacters:{type:"string"},indexerOthers:{type:"string"}}}},extension:{_INNER_ELEM:"ul",_WIDGET_NAME:"ojIndexer"}}),e.CustomElementBridge.register("oj-indexer",{metadata:e.CustomElementBridge.getMetadata("oj-indexer")})});